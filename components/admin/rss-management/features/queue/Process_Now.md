# Article Processing System

## Overview

The Article Processing System transforms raw RSS articles from the queue into AI-verified, fact-checked articles ready for editorial review. This system supports both individual article processing ("Process Now") and batch processing of multiple articles simultaneously.

## Processing Workflow

### Single Article Processing ("Process Now")

**Purpose:** Process individual queue articles on-demand for immediate verification and fact-checking.

**User Journey:**
1. User views article in Queue Tab
2. Clicks "Process Now" button on article card
3. System sends article to Perplexity API for fact-checking
4. AI response creates draft article in articles table
5. Queue item marked as processed
6. Article appears in the Articles section, Pending tab queue
7. User edits, deletes or approves article.
8. Article goes live on the site

**Processing Pipeline:**
```
Queue Article → Perplexity API → AI Fact-Check → Draft Article → Editorial Review
```

### Process Now Button States

**Default State:**
- **Label:** "Process Now"
- **Style:** Primary button with processing icon
- **Action:** Triggers single article processing

**Processing State:**
- **Label:** "Processing..." with spinner
- **Style:** Disabled button with loading indicator
- **Behavior:** Button disabled, prevents duplicate processing

**Completed State:**
- **Label:** "View Article"
- **Style:** Success variant with link icon
- **Action:** Navigates to created draft article

**Error State:**
- **Label:** "Retry Processing"
- **Style:** Warning variant with retry icon
- **Action:** Allows retry of failed processing

## Perplexity API Integration

### Single Article Prompt Template

```typescript
const singleArticlePrompt = `
I need you to fact-check and create a verified summary of this news article:

**Original Article:**
Title: ${article.title}
Description: ${article.description}
Source URL: ${article.url}
Category: ${article.category}

**Instructions:**
1. Research this story across 3+ additional reliable tech news sources
2. Fact-check the key claims and verify accuracy
3. Create a balanced, objective 300-word summary
4. Identify the most important facts and developments
5. Split body of text with new lines for every 1-2 sentences every 40-50 words
6. Suggest a descriptive image prompt for visual representation
7. Rate your confidence in the story's accuracy
8. Retain source urls at the bottom of the article

**Required JSON Response Format:**
{
  "verified_title": "Concise, accurate headline (max 80 chars)",
  "summary": "Balanced 300-word summary with key facts",
  "key_facts": ["Important fact 1", "Important fact 2", "Important fact 3"],
  "source_urls": ["https://source1.com", "https://source2.com", "https://source3.com"],
  "image_prompt": "Detailed description for AI image generation",
  "confidence_score": 0.85,
  "category_tags": ["tag1", "tag2", "tag3"],
  "verification_notes": "Brief notes on fact-checking process"
}

Please ensure all facts are verified and the summary is objective and informative.
`;
```

### API Response Processing

**Success Response Handling:**
```typescript
interface PerplexityResponse {
  verified_title: string;
  summary: string;
  key_facts: string[];
  source_urls: string[];
  image_prompt: string;
  confidence_score: number;
  category_tags: string[];
  verification_notes: string;
}

const processApiResponse = async (response: PerplexityResponse, queueItem: PendingArticle) => {
  // Create draft article from AI response
  const articleId = await ctx.runMutation(api.articles.create, {
    title: response.verified_title,
    content: response.summary,
    excerpt: response.summary.substring(0, 200) + "...",
    category: queueItem.category,
    topics: response.category_tags,
    status: "pending", // Awaiting editorial approval
    isAutoGenerated: true,
    sourceUrls: [queueItem.url, ...response.source_urls],
    rssSourceOrigin: [queueItem.sourceId],
    slug: generateSlug(response.verified_title),
    createdAt: Date.now(),
    // Processing metadata
    perplexityResponse: JSON.stringify(response),
    sourceArticleId: queueItem._id,
    processingCompletedAt: Date.now()
  });
  
  // Update queue item status
  await ctx.runMutation(api.pending_articles.markProcessed, {
    id: queueItem._id,
    resultingArticleId: articleId,
    processedAt: Date.now()
  });
  
  return articleId;
};
```

## Database Schema Updates

### Articles Table Enhancements

```typescript
articles: {
  // ... existing fields
  status: "draft" | "pending" | "approved" | "rejected" | "processing"
  
  // Processing metadata
  processingStartedAt?: number
  processingCompletedAt?: number
  perplexityResponse?: string        // Raw API response for debugging
  sourceArticleId?: Id<"pending_articles">  // Link back to queue item
  
  // AI-generated content flags
  isAutoGenerated: boolean
  confidenceScore?: number           // From Perplexity response
  verificationNotes?: string         // AI fact-checking notes
}
```

### Pending Articles Table Updates

```typescript
pending_articles: {
  // ... existing fields
  
  // Processing status
  isProcessing: boolean
  processedAt?: number
  processingError?: string
  resultingArticleId?: Id<"articles">  // Link to created article
  
  // Processing attempts
  processingAttempts: number
  lastProcessingAttempt?: number
}
```

## Error Handling & Recovery

### Processing Error Types

**API Errors:**
- Rate limit exceeded (429)
- API service unavailable (503)
- Invalid response format
- Timeout errors

**Content Errors:**
- Insufficient source verification
- Low confidence score (<0.6)
- Content policy violations
- Malformed article data

**Recovery Strategies:**
```typescript
const handleProcessingError = async (error: ProcessingError, queueItem: PendingArticle) => {
  const maxRetries = 3;
  const retryDelay = [5000, 15000, 60000]; // Exponential backoff
  
  switch (error.type) {
    case 'RATE_LIMIT':
      // Schedule retry after rate limit reset
      await scheduleRetry(queueItem._id, retryDelay[queueItem.processingAttempts]);
      break;
      
    case 'LOW_CONFIDENCE':
      // Mark for manual review instead of auto-processing
      await ctx.runMutation(api.pending_articles.markForManualReview, {
        id: queueItem._id,
        reason: 'Low confidence score from AI verification'
      });
      break;
      
    case 'API_TIMEOUT':
      if (queueItem.processingAttempts < maxRetries) {
        await retryProcessing(queueItem._id);
      } else {
        await markProcessingFailed(queueItem._id, error.message);
      }
      break;
  }
};
```

## UI Implementation

### Queue Item Card Updates

**Processing Button Component:**
```typescript
interface ProcessButtonProps {
  queueItem: PendingArticle;
  onProcessComplete: (articleId: Id<"articles">) => void;
}

const ProcessButton = ({ queueItem, onProcessComplete }: ProcessButtonProps) => {
  const [isProcessing, setIsProcessing] = useState(false);
  const processingMutation = useMutation(api.articles.processQueueItem);
  
  const handleProcessNow = async () => {
    try {
      setIsProcessing(true);
      const result = await processingMutation({
        pendingArticleId: queueItem._id
      });
      
      if (result.success) {
        toast.success("Article processed successfully!");
        onProcessComplete(result.articleId);
      } else {
        toast.error(result.error || "Processing failed");
      }
    } catch (error) {
      toast.error("Processing failed. Please try again.");
      console.error("Processing error:", error);
    } finally {
      setIsProcessing(false);
    }
  };
  
  // Render different button states based on processing status
  if (queueItem.processed) {
    return (
      <Button variant="outline" size="sm" asChild>
        <Link href={`/admin/articles/${queueItem.resultingArticleId}`}>
          <Eye className="w-4 h-4 mr-2" />
          View Article
        </Link>
      </Button>
    );
  }
  
  if (queueItem.processingError) {
    return (
      <Button 
        variant="destructive" 
        size="sm" 
        onClick={handleProcessNow}
        disabled={isProcessing}
      >
        <RefreshCw className="w-4 h-4 mr-2" />
        Retry Processing
      </Button>
    );
  }
  
  return (
    <Button 
      onClick={handleProcessNow} 
      disabled={isProcessing || queueItem.isProcessing}
      size="sm"
    >
      {isProcessing ? (
        <>
          <Loader2 className="w-4 h-4 mr-2 animate-spin" />
          Processing...
        </>
      ) : (
        <>
          <Zap className="w-4 h-4 mr-2" />
          Process Now
        </>
      )}
    </Button>
  );
};
```

### Processing Status Indicators

**Status Badge Component:**
```typescript
const ProcessingStatusBadge = ({ queueItem }: { queueItem: PendingArticle }) => {
  if (queueItem.isProcessing) {
    return (
      <Badge variant="secondary" className="animate-pulse">
        <Loader2 className="w-3 h-3 mr-1 animate-spin" />
        Processing
      </Badge>
    );
  }
  
  if (queueItem.processed) {
    return (
      <Badge variant="success">
        <CheckCircle className="w-3 h-3 mr-1" />
        Processed
      </Badge>
    );
  }
  
  if (queueItem.processingError) {
    return (
      <Badge variant="destructive">
        <XCircle className="w-3 h-3 mr-1" />
        Failed
      </Badge>
    );
  }
  
  return (
    <Badge variant="outline">
      <Clock className="w-3 h-3 mr-1" />
      Pending
    </Badge>
  );
};
```

## Performance Considerations

### API Rate Limiting
- Implement exponential backoff for retries
- Track API usage to stay within limits
- Queue processing requests during failures

### Processing Queue Management
- Prevent duplicate processing of same article
- Clean up old processed items periodically
- Monitor processing times and success rates

### Memory Optimization
- Stream large API responses
- Cleanup temporary processing data
- Efficient database queries for queue status

## Testing Checklist

### Functional Testing
- [ ] Process Now button triggers API call correctly
- [ ] Processing states update in real-time
- [ ] Draft articles created with proper data
- [ ] Queue items marked as processed
- [ ] Error handling works for API failures
- [ ] Retry functionality works after failures

### Edge Cases
- [ ] Handling malformed RSS articles
- [ ] Processing articles with missing data
- [ ] API timeout scenarios
- [ ] Concurrent processing attempts
- [ ] Very long article content

### Integration Testing
- [ ] Queue item updates reflect across tabs
- [ ] Created articles appear in articles table
- [ ] Processing status updates in real-time
- [ ] Error notifications display properly

## Future Enhancements

### Advanced Processing Features
- **Content Quality Scoring:** Rate articles based on source credibility
- **Duplicate Detection:** Advanced similarity matching beyond title hashing
- **Category Auto-tagging:** AI-powered category and topic suggestion
- **Processing Analytics:** Track success rates and processing times

### User Experience Improvements
- **Bulk Actions:** Select multiple articles for processing
- **Processing Queue:** Show current processing queue with progress
- **Processing History:** View processing logs and results
- **Custom Prompts:** Allow customization of Perplexity prompts